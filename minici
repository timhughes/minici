#!/usr/bin/env bash
# vim: set ft=sh ts=4 sw=4 tw=120 et :
#
# minici
# Copyright (C) 2015 Tim Hughes <thughes@thegoldfish.org>
#
# Distributed under terms of the MIT license.
#
# Simple test runner that watches for changes and executes all arguments
#
#     ./minici pytest
#
#
# inotify-tools for AL2 
# 
#    sudo yum install https://archives.fedoraproject.org/pub/archive/epel/7/x86_64/Packages/i/inotify-tools-3.14-9.el7.x86_64.rpm

_GREEN=$(tput setaf 2)
_BLUE=$(tput setaf 4)
_RED=$(tput setaf 1)
_RESET=$(tput sgr0)
_BOLD=$(tput bold)

if [[ $# -eq 0 ]] || [[ "$1" == "--help" ]] || [[ "$1" == "-h" ]]; then
	echo "Usage: $0 <command> [args...]"
	echo ""
	echo "A simple file watcher that runs commands when files change."
	echo ""
	echo "Examples:"
	echo "  $0 pytest"
	echo "  $0 npm test"
	echo "  $0 python -m unittest"
	echo ""
	echo "Options:"
	echo "  -h, --help    Show this help message"
	echo ""
	echo "For more information: https://github.com/timhughes/minici"
	exit 1
fi

if ! command -v inotifywait >/dev/null 2>&1; then
	echo "${_RED}inotify-tools is not installed${_RESET}" >&2
	exit 1
fi

# Check if the command exists before starting to watch
if ! command -v "$1" >/dev/null 2>&1; then
	echo "${_RED}Command not found: $1${_RESET}" >&2
	exit 1
fi

STALE_EVENT_SECS=1
EXCLUDE_REGEX='^\..*\.sw[px]*$|.*i\.log$|spec/fixtures|_trial_temp*|.pytest_cache|.watchman-cookie|^build|.coverage.*|.attach_pid*|_apidoc'

inotifywait --event close_write --monitor --recursive --timefmt "%Y-%m-%dT%H:%M:%S" --format "%T %e %w %f" --exclude "${EXCLUDE_REGEX}" . |
	while read -r event_time events directory filename; do
		# ignore events older than STALE_EVENT_SECS second
		if [[ $(($(date +%s) - $(date -d "${event_time}" +%s))) -ge ${STALE_EVENT_SECS} ]]; then
			continue
		fi
		if echo "$directory" | grep -q '^\./\.git.*' ||
			git check-ignore "${directory}/${filename}" >/dev/null 2>&1; then
			continue
		fi
		cols=${COLUMNS:-$(tput cols)}
		title=" minici "
		padding=$(( (cols - ${#title}) / 2 ))
		printf '%*s' $padding '' | tr ' ' =
		printf '%s' "$title"
		printf '%*s\n' $((cols - padding - ${#title})) '' | tr ' ' =
		echo "${_BLUE}File changed:${_RESET} ${directory}${filename}"
		echo "${_BLUE}Time:${_RESET} $(date -Iseconds)"
		echo "${_GREEN}Running:${_RESET} $*"
		printf '%*s\n' "${COLUMNS:-$(tput cols)}" '' | tr ' ' =
		"$@"
		exit_code=$?
		if [[ $exit_code -ne 0 ]]; then
			echo "${_RED}Command failed with exit code: $exit_code${_RESET}"
		fi
	done